<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Wochenstunden App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b2a4a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root { --blue:#0b2a4a; --bg:#f5f5f5; --card:#fff; --muted:#334155; }
    body { font-family: Arial, sans-serif; background:var(--bg); padding:20px; margin:0; }
    h1 { margin: 0 0 12px 0; font-size: 22px; }
    .wrap { max-width: 1100px; margin: 0 auto; }
    .box { background:var(--card); padding:15px; margin-bottom:15px; border:1px solid #e2e8f0; border-radius: 12px; }
    .topbar { display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap; }
    .lang { display:flex; gap:8px; align-items:center; }
    .lang label { margin:0; font-size: 12px; color: var(--muted); }
    select { padding:10px; border-radius:10px; border:1px solid #cbd5e1; background:#fff; }
    .grid { display:grid; grid-template-columns: 1fr 260px; gap: 12px; align-items:end; }
    label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    input, textarea { width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid #cbd5e1; font-size: 14px; }
    .small { font-size: 12px; color:var(--muted); margin-top: 6px; line-height: 1.3; }
    table { width:100%; border-collapse: collapse; background:var(--card); border-radius: 12px; overflow:hidden; border:1px solid #e2e8f0; }
    th, td { border:1px solid #e2e8f0; padding:8px; text-align:center; }
    th { background:var(--blue); color:white; border-color: var(--blue); font-size: 13px; }
    td.day { font-weight: 700; background:#f1f5f9; text-align:left; padding-left:10px; white-space:nowrap; }
    input.cell { padding:8px; border-radius:10px; border:1px solid #cbd5e1; }
    input.pause { width: 90px; }
    input.exp { width: 110px; }
    textarea.task { min-height: 38px; resize: vertical; }
    td.taskCell { text-align:left; }
    tfoot td { font-weight:bold; background:#f8fafc; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button { cursor:pointer; border-radius: 10px; padding:10px 12px; border:1px solid #1f2937; background:#111827; color:#fff; font-weight:700; }
    button.secondary { background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
    .sigRow { display:grid; grid-template-columns: 1fr; gap:10px; }
    .sigBox { border:1px dashed #94a3b8; border-radius:12px; padding:10px; background:#fff; }
    canvas { width:100%; height: 180px; touch-action: none; }
    .notice { background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; padding:10px 12px; border-radius: 12px; }
    @media (max-width: 860px){
      .grid { grid-template-columns: 1fr; }
      input.pause, input.exp { width: 100%; }
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <div class="topbar">
    <h1 id="title">Wochenbericht</h1>
    <div class="lang">
      <label for="langSel" id="langLabel">Sprache</label>
      <select id="langSel" aria-label="Sprache">
        <option value="de">DE</option>
        <option value="pl">PL</option>
      </select>
    </div>
  </div>

  <div class="box">
    <div class="small" id="hintInstall">
      Installierbar als App (PWA). Tipp: „PDF via WhatsApp“ nutzt die Teilen-Funktion am Handy.
    </div>
  </div>

  <div class="box">
    <div class="grid">
      <div>
        <label id="lblName">Name</label>
        <input id="name" placeholder="Name" />
      </div>
      <div>
        <label id="lblWeek">Woche (automatisch)</label>
        <div style="font-weight:700; padding:10px; border:1px solid #cbd5e1; border-radius:10px; background:#fff;">
          <span id="weekRange">–</span>
        </div>
        <div class="small" id="lblWeekSub">Wird automatisch aus dem heutigen Datum berechnet.</div>
      </div>
    </div>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th id="thDay">Tag</th>
        <th id="thStart">Start</th>
        <th id="thEnd">Ende</th>
        <th id="thPause">Pause (min)</th>
        <th id="thHours">Stunden</th>
        <th id="thTasks" style="min-width:220px;">Tätigkeiten</th>
        <th id="thExp">Spesen (€)</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <td colspan="4" id="tfSumLbl">Summe</td>
        <td id="sum">00:00</td>
        <td style="text-align:right;" id="tfSumExpLbl">Summe Spesen</td>
        <td id="sumExp">0.00</td>
      </tr>
    </tfoot>
  </table>

  <div class="box" style="margin-top:15px;">
    <div class="sigRow">
      <div><b id="sigTitle">Unterschrift</b></div>
      <div class="sigBox">
        <canvas id="sig" width="900" height="180"></canvas>
        <div class="small" id="sigSub">Hier unterschreiben</div>
      </div>
      <div class="actions">
        <button class="secondary" type="button" id="sigReset">Unterschrift zurücksetzen</button>
      </div>
    </div>
  </div>

  <div class="box">
    <div class="actions">
      <button type="button" id="btnPdf">Wochenbericht als PDF</button>
      <button class="secondary" type="button" id="btnShare">PDF via WhatsApp senden</button>
      <button class="secondary" type="button" id="btnResetWeek">Woche zurücksetzen</button>
    </div>
    <div class="small" id="autoResetHint">
      Automatik: Die Eingaben werden erst zurückgesetzt, wenn eine neue Kalenderwoche beginnt (oder per Button).
    </div>
    <div id="shareHint" class="small" style="margin-top:10px;"></div>
  </div>

  <div id="warn" class="notice" style="display:none; margin-bottom:15px;"></div>
</div>

<script>
const I18N = {
  de: {
    title: "Wochenbericht",
    langLabel: "Sprache",
    hintInstall: "Installierbar als App (PWA). Tipp: „PDF via WhatsApp“ nutzt die Teilen-Funktion am Handy.",
    name: "Name",
    week: "Woche (automatisch)",
    weekSub: "Wird automatisch aus dem heutigen Datum berechnet.",
    thDay: "Tag",
    thStart: "Start",
    thEnd: "Ende",
    thPause: "Pause (min)",
    thHours: "Stunden",
    thTasks: "Tätigkeiten",
    thExp: "Spesen (€)",
    sum: "Summe",
    sumExp: "Summe Spesen",
    sigTitle: "Unterschrift",
    sigSub: "Hier unterschreiben",
    sigReset: "Unterschrift zurücksetzen",
    btnPdf: "Wochenbericht als PDF",
    btnShare: "PDF via WhatsApp senden",
    btnResetWeek: "Woche zurücksetzen",
    autoReset: "Automatik: Die Eingaben werden erst zurückgesetzt, wenn eine neue Kalenderwoche beginnt (oder per Button).",
    shareOpened: "Teilen geöffnet. Bitte WhatsApp auswählen.",
    shareFallback: "Dein Browser unterstützt das direkte Teilen nicht. PDF wird heruntergeladen – anschließend in WhatsApp als Datei anhängen.",
    newWeek: (id) => "Neue Kalenderwoche erkannt (" + id + "). Die Eingaben wurden zurückgesetzt.",
    days: ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"],
    weekSep: "bis",
    pdfTitle: "Wochenbericht",
    pdfName: "Name: ",
    pdfWeek: "Woche: ",
    pdfSumH: "Summe Stunden: ",
    pdfSumE: "Summe Spesen: ",
    pdfSig: "Unterschrift:"
  },
  pl: {
    title: "Raport tygodniowy",
    langLabel: "Język",
    hintInstall: "Można zainstalować jako aplikację (PWA). Wskazówka: „PDF przez WhatsApp” używa funkcji udostępniania w telefonie.",
    name: "Imię i nazwisko",
    week: "Tydzień (automatycznie)",
    weekSub: "Wyliczane automatycznie na podstawie dzisiejszej daty.",
    thDay: "Dzień",
    thStart: "Start",
    thEnd: "Koniec",
    thPause: "Przerwa (min)",
    thHours: "Godziny",
    thTasks: "Czynności",
    thExp: "Diety (€)",
    sum: "Suma",
    sumExp: "Suma diet",
    sigTitle: "Podpis",
    sigSub: "Podpisz tutaj",
    sigReset: "Wyczyść podpis",
    btnPdf: "Pobierz PDF",
    btnShare: "Wyślij PDF przez WhatsApp",
    btnResetWeek: "Reset tygodnia",
    autoReset: "Automatycznie: dane zerują się dopiero, gdy zacznie się nowy tydzień (lub przyciskiem).",
    shareOpened: "Otwarto udostępnianie. Wybierz WhatsApp.",
    shareFallback: "Twoja przeglądarka nie obsługuje udostępniania plików. PDF zostanie pobrany – potem dodaj go w WhatsApp jako plik.",
    newWeek: (id) => "Wykryto nowy tydzień (" + id + "). Dane zostały zresetowane.",
    days: ["Poniedziałek","Wtorek","Środa","Czwartek","Piątek","Sobota"],
    weekSep: "do",
    pdfTitle: "Raport tygodniowy",
    pdfName: "Imię i nazwisko: ",
    pdfWeek: "Tydzień: ",
    pdfSumH: "Suma godzin: ",
    pdfSumE: "Suma diet: ",
    pdfSig: "Podpis:"
  }
};

function setText(id, value){ const el = document.getElementById(id); if(el) el.innerText = value; }

function pad2(n){ return String(n).padStart(2,"0"); }
function fmtDMY(d){ return pad2(d.getDate()) + "." + pad2(d.getMonth()+1) + "." + d.getFullYear(); }
function isoWeekYear(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return { week: weekNo, year: d.getUTCFullYear() };
}
function weekStartEndFromToday(){
  const d = new Date();
  const day = d.getDay();
  const diffToMon = (day === 0 ? -6 : 1 - day);
  const mon = new Date(d); mon.setDate(d.getDate() + diffToMon);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
  return { mon, sun };
}
function currentWeekId(){
  const today = new Date();
  const w = isoWeekYear(today);
  return w.year + "-W" + String(w.week).padStart(2,"0");
}

function getLang(){
  const sel = document.getElementById("langSel").value || "de";
  return (sel === "pl") ? "pl" : "de";
}

function setWeekRange(){
  const r = weekStartEndFromToday();
  const t = I18N[getLang()];
  document.getElementById("weekRange").innerText = fmtDMY(r.mon) + " " + t.weekSep + " " + fmtDMY(r.sun);
}

const tbody = document.getElementById("tbody");

function buildRows(){
  tbody.innerHTML = "";
  const t = I18N[getLang()];
  t.days.forEach(day => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td class="day">${day}</td>
      <td><input type="time" class="start cell"></td>
      <td><input type="time" class="end cell"></td>
      <td><input type="number" class="pause cell pause" value="0" min="0"></td>
      <td class="hours">00:00</td>
      <td class="taskCell"><textarea class="task" placeholder="${t.thTasks}..."></textarea></td>
      <td><input type="number" class="exp cell exp" value="0" min="0" step="0.01"></td>
    `;
    tbody.appendChild(tr);
  });
}

function toMin(t){ if(!t) return 0; const [h,m]=t.split(":").map(Number); return h*60+m; }
function toHHMM(m){ const h=Math.floor(m/60); const mm=m%60; return String(h).padStart(2,"0")+":"+String(mm).padStart(2,"0"); }

function readRows(){
  return Array.from(document.querySelectorAll("#table tbody tr")).map(r=>({
    start: r.querySelector(".start").value,
    end: r.querySelector(".end").value,
    pause: r.querySelector(".pause").value,
    task: r.querySelector(".task").value,
    exp: r.querySelector(".exp").value
  }));
}
function writeRows(rows){
  const trs = document.querySelectorAll("#table tbody tr");
  (rows || []).forEach((rr,i)=>{
    if(!trs[i]) return;
    trs[i].querySelector(".start").value = rr.start || "";
    trs[i].querySelector(".end").value = rr.end || "";
    trs[i].querySelector(".pause").value = rr.pause || "0";
    trs[i].querySelector(".task").value = rr.task || "";
    trs[i].querySelector(".exp").value = rr.exp || "0";
  });
}

function calc(){
  let total=0, totalExp=0;
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    const s=toMin(r.querySelector(".start").value);
    const e=toMin(r.querySelector(".end").value);
    const p=parseInt(r.querySelector(".pause").value||0);
    let d=e-s-p; if(d<0) d=0;
    r.querySelector(".hours").innerText=toHHMM(d);
    total+=d;
    const exp = parseFloat(r.querySelector(".exp").value || "0");
    if(!Number.isNaN(exp)) totalExp += exp;
  });
  document.getElementById("sum").innerText=toHHMM(total);
  document.getElementById("sumExp").innerText=totalExp.toFixed(2);
  save();
}

/* Signature */
const sigCanvas = document.getElementById("sig");
const sigCtx = sigCanvas.getContext("2d");
sigCtx.lineWidth = 2.5; sigCtx.lineCap = "round"; sigCtx.strokeStyle = "#0f172a";
let drawing=false, last=null;
function getPos(e){
  const rect = sigCanvas.getBoundingClientRect();
  const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
  const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
  const x = (clientX - rect.left) * (sigCanvas.width / rect.width);
  const y = (clientY - rect.top) * (sigCanvas.height / rect.height);
  return {x,y};
}
function sigStart(e){ drawing=true; last=getPos(e); e.preventDefault(); }
function sigMove(e){
  if(!drawing) return;
  const p=getPos(e);
  sigCtx.beginPath(); sigCtx.moveTo(last.x,last.y); sigCtx.lineTo(p.x,p.y); sigCtx.stroke();
  last=p; e.preventDefault();
}
function sigEnd(e){ drawing=false; last=null; save(); e.preventDefault(); }
sigCanvas.addEventListener("mousedown", sigStart);
sigCanvas.addEventListener("mousemove", sigMove);
window.addEventListener("mouseup", sigEnd);
sigCanvas.addEventListener("touchstart", sigStart, {passive:false});
sigCanvas.addEventListener("touchmove", sigMove, {passive:false});
sigCanvas.addEventListener("touchend", sigEnd, {passive:false});
function clearSignature(){ sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); save(); }
document.getElementById("sigReset").addEventListener("click", clearSignature);

/* Persistence + auto weekly reset */
const STORE_KEY = "wochenstunden-pwa:v4";
function resetWeekData(){
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    r.querySelector(".start").value="";
    r.querySelector(".end").value="";
    r.querySelector(".pause").value="0";
    r.querySelector(".hours").innerText="00:00";
    r.querySelector(".task").value="";
    r.querySelector(".exp").value="0";
  });
  clearSignature();
  calc();
  save();
}

function applyLang(lang){
  const t = I18N[lang];
  document.documentElement.lang = lang;
  setText("title", t.title);
  setText("langLabel", t.langLabel);
  setText("hintInstall", t.hintInstall);
  setText("lblName", t.name);
  setText("lblWeek", t.week);
  setText("lblWeekSub", t.weekSub);
  setText("thDay", t.thDay);
  setText("thStart", t.thStart);
  setText("thEnd", t.thEnd);
  setText("thPause", t.thPause);
  setText("thHours", t.thHours);
  setText("thTasks", t.thTasks);
  setText("thExp", t.thExp);
  setText("tfSumLbl", t.sum);
  setText("tfSumExpLbl", t.sumExp);
  setText("sigTitle", t.sigTitle);
  setText("sigSub", t.sigSub);
  setText("sigReset", t.sigReset);
  setText("btnPdf", t.btnPdf);
  setText("btnShare", t.btnShare);
  setText("btnResetWeek", t.btnResetWeek);
  setText("autoResetHint", t.autoReset);

  const existing = readRows();
  buildRows();
  writeRows(existing);
  setWeekRange();
  calc();
}

function save(){
  const data = {
    weekId: currentWeekId(),
    weekRange: document.getElementById("weekRange").innerText,
    name: document.getElementById("name").value,
    lang: getLang(),
    rows: readRows(),
    signature: sigCanvas.toDataURL("image/png")
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
}

function load(){
  const raw = localStorage.getItem(STORE_KEY);
  const todayId = currentWeekId();
  const browserLang = (navigator.language || "").toLowerCase().startsWith("pl") ? "pl" : "de";
  document.getElementById("langSel").value = browserLang;

  buildRows();
  applyLang(getLang());

  if(!raw){ save(); return; }
  try{
    const data = JSON.parse(raw);
    if(data.lang) document.getElementById("langSel").value = data.lang;

    applyLang(getLang());

    if(data.weekId && data.weekId !== todayId){
      const t = I18N[getLang()];
      document.getElementById("warn").style.display = "block";
      document.getElementById("warn").innerText = t.newWeek(todayId);
      document.getElementById("name").value = data.name || "";
      resetWeekData();
      save();
      return;
    }

    document.getElementById("name").value = data.name || "";
    writeRows(data.rows || []);

    if(data.signature){
      const img = new Image();
      img.onload = () => { sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); sigCtx.drawImage(img, 0, 0, sigCanvas.width, sigCanvas.height); };
      img.src = data.signature;
    }
  }catch(e){}
}

/* PDF + Share */
async function makePdfBlob(){
  if(!window.jspdf || !window.jspdf.jsPDF){ throw new Error("jsPDF konnte nicht geladen werden (CDN)."); }
  const t = I18N[getLang()];
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });

  const name = document.getElementById("name").value || "-";
  const weekRange = document.getElementById("weekRange").innerText || "-";
  const sum = document.getElementById("sum").innerText || "00:00";
  const sumExp = document.getElementById("sumExp").innerText || "0.00";

  doc.setFontSize(16); doc.text(t.pdfTitle, 40, 50);
  doc.setFontSize(10);
  doc.text(t.pdfName + name, 40, 75);
  doc.text(t.pdfWeek + weekRange, 40, 92);

  let y = 125;
  doc.setFontSize(9);
  doc.text(t.thDay, 40, y);
  doc.text(t.thStart, 120, y);
  doc.text(t.thEnd, 180, y);
  doc.text(t.thPause, 240, y);
  doc.text(t.thHours, 300, y);
  doc.text(t.thTasks, 345, y);
  doc.text(t.thExp, 520, y, {align:"right"});
  y += 10; doc.line(40, y, 555, y); y += 14;

  const dayLabels = I18N[getLang()].days;
  document.querySelectorAll("#table tbody tr").forEach((r, idx)=>{
    const day = dayLabels[idx] || r.children[0].innerText;
    const s = r.querySelector(".start").value || "-";
    const e = r.querySelector(".end").value || "-";
    const p = r.querySelector(".pause").value || "0";
    const h = r.querySelector(".hours").innerText || "00:00";
    const task = (r.querySelector(".task").value || "").slice(0, 40);
    const exp = parseFloat(r.querySelector(".exp").value || "0");

    doc.text(day, 40, y);
    doc.text(s, 120, y);
    doc.text(e, 180, y);
    doc.text(String(p), 270, y, {align:"right"});
    doc.text(h, 300, y);
    doc.text(task, 345, y);
    doc.text((Number.isNaN(exp) ? "0.00" : exp.toFixed(2)), 520, y, {align:"right"});
    y += 16;
    if(y > 720){ doc.addPage(); y = 60; }
  });

  y += 6; doc.line(40, y, 555, y); y += 18;
  doc.setFontSize(10);
  doc.text(t.pdfSumH + sum, 40, y);
  doc.text(t.pdfSumE + sumExp + " €", 320, y);

  y += 26;
  doc.text(t.pdfSig, 40, y);
  y += 8;
  doc.addImage(sigCanvas.toDataURL("image/png"), "PNG", 40, y, 220, 70);

  const arrayBuf = doc.output("arraybuffer");
  return new Blob([arrayBuf], { type: "application/pdf" });
}

document.getElementById("btnPdf").addEventListener("click", async () => {
  try{
    const blob = await makePdfBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Wochenbericht.pdf";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }catch(e){ alert(String(e.message || e)); }
});

document.getElementById("btnShare").addEventListener("click", async () => {
  const hint = document.getElementById("shareHint");
  hint.innerText = "";
  try{
    const t = I18N[getLang()];
    const blob = await makePdfBlob();
    const file = new File([blob], "Wochenbericht.pdf", { type: "application/pdf" });
    if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ title: t.pdfTitle, text: t.pdfTitle + " (PDF)", files: [file] });
      hint.innerText = t.shareOpened;
      return;
    }
    hint.innerText = t.shareFallback;
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = file.name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }catch(e){ alert(String(e.message || e)); }
});

document.getElementById("btnResetWeek").addEventListener("click", () => {
  resetWeekData();
  save();
});

document.getElementById("langSel").addEventListener("change", () => {
  applyLang(getLang());
  save();
});

document.addEventListener("input", calc);

(function init(){
  load();
  setWeekRange();
  calc();
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }
})();
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>Wochenstunden App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#0b2a4a" />
  <link rel="manifest" href="manifest.webmanifest" />
  <style>
    :root { --blue:#0b2a4a; --bg:#f5f5f5; --card:#fff; --muted:#334155; }
    body { font-family: Arial, sans-serif; background:var(--bg); padding:20px; margin:0; }
    h1 { margin: 0 0 12px 0; font-size: 22px; }
    .wrap { max-width: 980px; margin: 0 auto; }
    .box { background:var(--card); padding:15px; margin-bottom:15px; border:1px solid #e2e8f0; border-radius: 12px; }
    .grid { display:grid; grid-template-columns: 1fr 120px 180px; gap: 12px; }
    .grid label { font-size: 12px; color: var(--muted); display:block; margin-bottom: 6px; }
    .grid input { width:100%; box-sizing:border-box; padding:10px; border-radius:10px; border:1px solid #cbd5e1; }
    .small { font-size: 12px; color:var(--muted); margin-top: 6px; line-height: 1.3; }
    table { width:100%; border-collapse: collapse; background:var(--card); border-radius: 12px; overflow:hidden; border:1px solid #e2e8f0; }
    th, td { border:1px solid #e2e8f0; padding:8px; text-align:center; }
    th { background:var(--blue); color:white; border-color: var(--blue); font-size: 13px; }
    td.day { font-weight: 700; background:#f1f5f9; text-align:left; padding-left:10px; }
    input.cell { width:100%; box-sizing:border-box; padding:8px; border-radius:10px; border:1px solid #cbd5e1; }
    tfoot td { font-weight:bold; background:#f8fafc; }
    .actions { display:flex; gap:10px; flex-wrap:wrap; margin-top: 12px; }
    button { cursor:pointer; border-radius: 10px; padding:10px 12px; border:1px solid #1f2937; background:#111827; color:#fff; font-weight:700; }
    button.secondary { background:#fff; color:#0f172a; border:1px solid #cbd5e1; }
    .sigRow { display:grid; grid-template-columns: 1fr; gap:10px; }
    .sigBox { border:1px dashed #94a3b8; border-radius:12px; padding:10px; background:#fff; }
    canvas { width:100%; height: 180px; touch-action: none; }
    .notice { background:#fff7ed; border:1px solid #fed7aa; color:#7c2d12; padding:10px 12px; border-radius: 12px; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.2/dist/jspdf.umd.min.js"></script>
</head>
<body>
<div class="wrap">
  <h1>Wochenbericht</h1>

  <div class="box">
    <div class="small">
      Installierbar als App (PWA): Chrome/Edge → Menü → „App installieren“.<br>
      Hinweis: „PDF via WhatsApp“ geht am zuverlässigsten über die Teilen-Funktion am Handy.
    </div>
  </div>

  <div class="box">
    <div class="grid">
      <div>
        <label>Name</label>
        <input id="name" placeholder="Name" />
      </div>
      <div>
        <label>KW</label>
        <input id="kw" placeholder="z.B. 52" />
      </div>
      <div>
        <label>Datum (für die Woche)</label>
        <input type="date" id="date" />
        <div class="small">Woche: <b id="weekRange">–</b></div>
      </div>
    </div>
  </div>

  <table id="table">
    <thead>
      <tr>
        <th>Tag</th>
        <th>Start</th>
        <th>Ende</th>
        <th>Pause (min)</th>
        <th>Stunden</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
    <tfoot>
      <tr>
        <td colspan="4">Summe</td>
        <td id="sum">00:00</td>
      </tr>
    </tfoot>
  </table>

  <div class="box" style="margin-top:15px;">
    <div class="sigRow">
      <div><b>Unterschrift</b></div>
      <div class="sigBox">
        <canvas id="sig" width="900" height="180"></canvas>
        <div class="small">Hier unterschreiben</div>
      </div>
      <div class="actions">
        <button class="secondary" type="button" id="sigReset">Unterschrift zurücksetzen</button>
      </div>
    </div>
  </div>

  <div class="box">
    <div class="actions">
      <button type="button" id="btnPdf">Wochenbericht als PDF</button>
      <button class="secondary" type="button" id="btnShare">PDF via WhatsApp senden</button>
      <button class="secondary" type="button" id="btnResetWeek">Woche zurücksetzen</button>
    </div>
    <div class="small">
      Automatik: Die Eingaben werden erst zurückgesetzt, wenn eine neue Kalenderwoche beginnt (oder per Button).
    </div>
    <div id="shareHint" class="small" style="margin-top:10px;"></div>
  </div>

  <div id="warn" class="notice" style="display:none; margin-bottom:15px;"></div>
</div>

<script>
function pad2(n){ return String(n).padStart(2,"0"); }
function toISODate(d){ return d.getFullYear()+"-"+pad2(d.getMonth()+1)+"-"+pad2(d.getDate()); }
function isoWeekYear(date){
  const d = new Date(Date.UTC(date.getFullYear(), date.getMonth(), date.getDate()));
  const dayNum = d.getUTCDay() || 7;
  d.setUTCDate(d.getUTCDate() + 4 - dayNum);
  const yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
  const weekNo = Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
  return { week: weekNo, year: d.getUTCFullYear() };
}
function weekStartEnd(date){
  const d = new Date(date.getFullYear(), date.getMonth(), date.getDate());
  const day = d.getDay();
  const diffToMon = (day === 0 ? -6 : 1 - day);
  const mon = new Date(d); mon.setDate(d.getDate() + diffToMon);
  const sun = new Date(mon); sun.setDate(mon.getDate() + 6);
  return { mon, sun };
}
function setWeekRangeFromDate(){
  const dateVal = document.getElementById("date").value;
  if(!dateVal){ document.getElementById("weekRange").innerText = "–"; return; }
  const [y,m,da] = dateVal.split("-").map(Number);
  const d = new Date(y, m-1, da);
  const r = weekStartEnd(d);
  document.getElementById("weekRange").innerText = toISODate(r.mon) + " bis " + toISODate(r.sun);
}

const days = ["Montag","Dienstag","Mittwoch","Donnerstag","Freitag","Samstag"];
const tbody = document.getElementById("tbody");
function rowTemplate(day){
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td class="day">${day}</td>
    <td><input type="time" class="start cell"></td>
    <td><input type="time" class="end cell"></td>
    <td><input type="number" class="pause cell" value="0" min="0"></td>
    <td class="hours">00:00</td>
  `;
  return tr;
}
days.forEach(d => tbody.appendChild(rowTemplate(d)));

function toMin(t){ if(!t) return 0; const [h,m]=t.split(":").map(Number); return h*60+m; }
function toHHMM(m){ const h=Math.floor(m/60); const mm=m%60; return String(h).padStart(2,"0")+":"+String(mm).padStart(2,"0"); }
function calc(){
  let total=0;
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    const s=toMin(r.querySelector(".start").value);
    const e=toMin(r.querySelector(".end").value);
    const p=parseInt(r.querySelector(".pause").value||0);
    let d=e-s-p; if(d<0) d=0;
    r.querySelector(".hours").innerText=toHHMM(d);
    total+=d;
  });
  document.getElementById("sum").innerText=toHHMM(total);
  save();
}

const sigCanvas = document.getElementById("sig");
const sigCtx = sigCanvas.getContext("2d");
sigCtx.lineWidth = 2.5;
sigCtx.lineCap = "round";
sigCtx.strokeStyle = "#0f172a";
let drawing = false;
let last = null;
function getPos(e){
  const rect = sigCanvas.getBoundingClientRect();
  const clientX = (e.touches ? e.touches[0].clientX : e.clientX);
  const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
  const x = (clientX - rect.left) * (sigCanvas.width / rect.width);
  const y = (clientY - rect.top) * (sigCanvas.height / rect.height);
  return {x,y};
}
function sigStart(e){ drawing = true; last = getPos(e); e.preventDefault(); }
function sigMove(e){
  if(!drawing) return;
  const p = getPos(e);
  sigCtx.beginPath();
  sigCtx.moveTo(last.x, last.y);
  sigCtx.lineTo(p.x, p.y);
  sigCtx.stroke();
  last = p;
  e.preventDefault();
}
function sigEnd(e){ drawing = false; last = null; save(); e.preventDefault(); }
sigCanvas.addEventListener("mousedown", sigStart);
sigCanvas.addEventListener("mousemove", sigMove);
window.addEventListener("mouseup", sigEnd);
sigCanvas.addEventListener("touchstart", sigStart, {passive:false});
sigCanvas.addEventListener("touchmove", sigMove, {passive:false});
sigCanvas.addEventListener("touchend", sigEnd, {passive:false});
function clearSignature(){ sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); save(); }
document.getElementById("sigReset").addEventListener("click", clearSignature);

const STORE_KEY = "wochenstunden-pwa:v2";
function currentWeekId(){
  const dateVal = document.getElementById("date").value;
  let d;
  if(dateVal){ const [y,m,da] = dateVal.split("-").map(Number); d = new Date(y, m-1, da); }
  else { d = new Date(); }
  const w = isoWeekYear(d);
  return w.year + "-W" + String(w.week).padStart(2,"0");
}
function resetWeekData(keepHeader=true){
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    r.querySelector(".start").value = "";
    r.querySelector(".end").value = "";
    r.querySelector(".pause").value = "0";
    r.querySelector(".hours").innerText = "00:00";
  });
  clearSignature();
  if(!keepHeader){
    document.getElementById("name").value = "";
    document.getElementById("kw").value = "";
    document.getElementById("date").value = "";
    setWeekRangeFromDate();
  }
  document.getElementById("sum").innerText = "00:00";
  save();
}
function save(){
  const data = {
    weekId: currentWeekId(),
    name: document.getElementById("name").value,
    kw: document.getElementById("kw").value,
    date: document.getElementById("date").value,
    range: document.getElementById("weekRange").innerText,
    rows: Array.from(document.querySelectorAll("#table tbody tr")).map(r=>({
      start: r.querySelector(".start").value,
      end: r.querySelector(".end").value,
      pause: r.querySelector(".pause").value
    })),
    signature: sigCanvas.toDataURL("image/png")
  };
  localStorage.setItem(STORE_KEY, JSON.stringify(data));
}
function load(){
  const raw = localStorage.getItem(STORE_KEY);
  if(!raw) return;
  try{
    const data = JSON.parse(raw);
    const todayWeek = isoWeekYear(new Date());
    const todayId = todayWeek.year + "-W" + String(todayWeek.week).padStart(2,"0");
    if(data.weekId && data.weekId !== todayId){
      document.getElementById("warn").style.display = "block";
      document.getElementById("warn").innerText = "Neue Kalenderwoche erkannt ("+todayId+"). Die Zeiten/Unterschrift wurden zurückgesetzt.";
      document.getElementById("name").value = data.name || "";
      document.getElementById("kw").value = String(todayWeek.week);
      document.getElementById("date").value = toISODate(new Date());
      setWeekRangeFromDate();
      resetWeekData(true);
      save();
      return;
    }
    document.getElementById("name").value = data.name || "";
    document.getElementById("kw").value = data.kw || "";
    document.getElementById("date").value = data.date || "";
    setWeekRangeFromDate();
    const trs = document.querySelectorAll("#table tbody tr");
    (data.rows || []).forEach((rr,i)=>{
      if(!trs[i]) return;
      trs[i].querySelector(".start").value = rr.start || "";
      trs[i].querySelector(".end").value = rr.end || "";
      trs[i].querySelector(".pause").value = rr.pause || "0";
    });
    if(data.signature){
      const img = new Image();
      img.onload = () => { sigCtx.clearRect(0,0,sigCanvas.width,sigCanvas.height); sigCtx.drawImage(img, 0, 0, sigCanvas.width, sigCanvas.height); };
      img.src = data.signature;
    }
  }catch(e){}
}
document.getElementById("btnResetWeek").addEventListener("click", () => resetWeekData(true));
document.getElementById("date").addEventListener("change", () => {
  setWeekRangeFromDate();
  const [y,m,da] = document.getElementById("date").value.split("-").map(Number);
  const w = isoWeekYear(new Date(y, m-1, da));
  if(!document.getElementById("kw").value) document.getElementById("kw").value = String(w.week);
  save();
});
document.addEventListener("input", calc);

async function makePdfBlob(){
  if(!window.jspdf || !window.jspdf.jsPDF){ throw new Error("jsPDF konnte nicht geladen werden (CDN)."); }
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({ unit: "pt", format: "a4" });
  const name = document.getElementById("name").value || "-";
  const kw = document.getElementById("kw").value || "-";
  const date = document.getElementById("date").value || "-";
  const range = document.getElementById("weekRange").innerText || "-";
  doc.setFontSize(16); doc.text("Wochenbericht", 40, 50);
  doc.setFontSize(10);
  doc.text("Name: " + name, 40, 75);
  doc.text("KW: " + kw, 420, 75);
  doc.text("Woche: " + range, 40, 92);
  doc.text("Datum: " + date, 40, 109);
  let y = 135;
  doc.setFontSize(9);
  doc.text("Tag", 40, y); doc.text("Start", 160, y); doc.text("Ende", 240, y); doc.text("Pause", 320, y); doc.text("Stunden", 400, y);
  y += 10; doc.line(40, y, 555, y); y += 14;
  document.querySelectorAll("#table tbody tr").forEach(r=>{
    const day = r.children[0].innerText;
    const s = r.querySelector(".start").value || "-";
    const e = r.querySelector(".end").value || "-";
    const p = r.querySelector(".pause").value || "0";
    const h = r.querySelector(".hours").innerText || "00:00";
    doc.text(day, 40, y);
    doc.text(s, 160, y);
    doc.text(e, 240, y);
    doc.text(String(p), 330, y, {align:"right"});
    doc.text(h, 400, y);
    y += 16;
  });
  y += 6; doc.line(40, y, 555, y); y += 18;
  doc.setFontSize(10);
  doc.text("Summe: " + document.getElementById("sum").innerText, 40, y);
  y += 24; doc.text("Unterschrift:", 40, y); y += 8;
  const sigData = sigCanvas.toDataURL("image/png");
  doc.addImage(sigData, "PNG", 40, y, 220, 70);
  const arrayBuf = doc.output("arraybuffer");
  return new Blob([arrayBuf], { type: "application/pdf" });
}

document.getElementById("btnPdf").addEventListener("click", async () => {
  try{
    const blob = await makePdfBlob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "Wochenbericht_KW" + (document.getElementById("kw").value || "xx") + ".pdf";
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }catch(e){ alert(String(e.message || e)); }
});

document.getElementById("btnShare").addEventListener("click", async () => {
  const hint = document.getElementById("shareHint");
  hint.innerText = "";
  try{
    const blob = await makePdfBlob();
    const file = new File([blob], "Wochenbericht_KW" + (document.getElementById("kw").value || "xx") + ".pdf", { type: "application/pdf" });
    if(navigator.share && navigator.canShare && navigator.canShare({ files: [file] })){
      await navigator.share({ title: "Wochenbericht", text: "Wochenbericht (PDF)", files: [file] });
      hint.innerText = "Teilen geöffnet. Bitte WhatsApp auswählen.";
      return;
    }
    hint.innerText = "Direktes Teilen wird von deinem Browser nicht unterstützt. PDF wird heruntergeladen – anschließend in WhatsApp als Datei anhängen.";
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url; a.download = file.name;
    document.body.appendChild(a); a.click(); a.remove();
    setTimeout(()=>URL.revokeObjectURL(url), 1000);
  }catch(e){ alert(String(e.message || e)); }
});

(function init(){
  const dateEl = document.getElementById("date");
  if(!dateEl.value){
    dateEl.value = toISODate(new Date());
    const w = isoWeekYear(new Date());
    if(!document.getElementById("kw").value) document.getElementById("kw").value = String(w.week);
  }
  setWeekRangeFromDate();
  load();
  calc();
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => navigator.serviceWorker.register("./sw.js"));
  }
})();
</script>
</body>
</html>
